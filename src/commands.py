"""Module containing the bot commands."""

import logging
import os
from typing import List, Tuple

from schedule import Job
from telegram import BotCommand, Bot, Update, Message, InlineQueryResultArticle, ParseMode, InputTextMessageContent
from telegram.error import BadRequest
from telegram.ext import CommandHandler, JobQueue
from telegram.utils.helpers import effective_message_type

from src.common import restricted, parse_article, reply_to_message, get_param, guidebook, delete_command, \
    format_knowledge_results, send_results
from src.config import REMINDER_INTERVAL_INFO, SOCIAL_JOB, REMINDER_INTERVAL_PINNED, PINNED_JOB, REMINDER_MESSAGE, \
    BERLIN_HELPS_UKRAINE_CHAT_ID, ADMIN_ONLY_CHAT_IDS, THUMB_URL, MONGO_HOST, MONGO_USER, MONGO_PASS, MONGO_BASE
from src.guidebook import NameType
from src.mongo import connect
from src.services import Articles

db = connect(MONGO_HOST, MONGO_USER, MONGO_PASS, MONGO_BASE)
TEST_CHAT = "tests"
articles_service = Articles(db, TEST_CHAT)

logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO
)
logger = logging.getLogger(__name__)


def help_text():
    return (
            "–ü—Ä–∏–≤–µ—Ç! ü§ñ "
            + os.linesep
            + "–Ø –±–æ—Ç –¥–ª—è –ø–æ–º–æ—â–∏ –±–µ–∂–µ–Ω—Ü–∞–º –∏–∑ –£–∫—Ä–∞–∏–Ω—ã üá∫üá¶ –≤ –ì–µ—Ä–º–∞–Ω–∏–∏. "
            + os.linesep
            + "–ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –º–æ–∏—Ö –∑–Ω–∞–Ω–∏–π –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ –ë–µ—Ä–ª–∏–Ω—É, –Ω–æ –µ—Å—Ç—å –∏ –æ–±—â–∞—è "
            + "–ø–æ–ª–µ–∑–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è. –ß—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –∫–æ–º–∞–Ω–¥, "
            + "–≤–≤–µ–¥–∏—Ç–µ —Å–∏–º–≤–æ–ª '/'. "
            + "\n\n"
            + "–ï—Å–ª–∏ –¥–æ–±–∞–≤–∏—Ç–µ –º–µ–Ω—è –≤ —Å–≤–æ–π —á–∞—Ç, –Ω–µ –∑–∞–±—É–¥—å—Ç–µ –¥–∞—Ç—å –º–Ω–µ –ø—Ä–∞–≤–∞ "
            + "–∞–¥–º–∏–Ω–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —á—Ç–æ–±—ã —è –º–æ–≥ —É–¥–∞–ª—è—Ç—å –Ω–µ–Ω—É–∂–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å "
            + "–≤—ã–∑–≤–∞–Ω–Ω—ã–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏."
            + "\n\n\n"
            + "–í—ñ—Ç–∞–Ω–Ω—è! ü§ñ "
            + os.linesep
            + "–Ø –±–æ—Ç –¥–ª—è –¥–æ–ø–æ–º–æ–≥–∏ –±—ñ–∂–µ–Ω—Ü—è–º –∑ –£–∫—Ä–∞—ó–Ω–∏ üá∫üá¶ –≤ –ù—ñ–º–µ—á—á–∏–Ω—ñ."
            + os.linesep
            + "–ë—ñ–ª—å—à—ñ—Å—Ç—å –º–æ—ó—Ö –∑–Ω–∞–Ω—å —Å—Ç–æ—Å—É—é—Ç—å—Å—è –ë–µ—Ä–ª—ñ–Ω—É, –∞–ª–µ —î –π –∑–∞–≥–∞–ª—å–Ω–∞ "
            + "–∫–æ—Ä–∏—Å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è. –©–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥, —â–æ –ø—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å—Å—è, "
            + "–≤–≤–µ–¥—ñ—Ç—å —Å–∏–º–≤–æ–ª '/'. "
            + "\n\n"
            + "–Ø–∫—â–æ –¥–æ–¥–∞—Å—Ç–µ –º–µ–Ω–µ –¥–æ —Å–≤–æ–≥–æ —á–∞—Ç—É, –±—É–¥—å –ª–∞—Å–∫–∞, –Ω–µ –∑–∞–±—É–¥—å—Ç–µ –Ω–∞–¥–∞—Ç–∏ "
            + "–º–µ–Ω—ñ –ø—Ä–∞–≤–∞ –∞–¥–º—ñ–Ω–∞, —â–æ–± —è –∑–º—ñ–≥ –≤–∏–¥–∞–ª—è—Ç–∏ –Ω–µ–ø–æ—Ç—Ä—ñ–±–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —ñ–∑ "
            + "–≤–∏–∫–ª–∏–∫–∞–Ω–∏–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏."
            + "\n\n\n"
            + "Hi! ü§ñ"
            + os.linesep
            + "I'm a bot helping refugees from Ukraine üá∫üá¶ in Germany. "
            + os.linesep
            + "Most of my knowledge focuses on Berlin, but I have some "
            + "general useful information too. Type '/' to see the list of my "
            + "available commands."
            + "\n\n"
            + "If you add me to your chat, don't forget to grant me admin "
            + "rights, so that I can delete log messages and keep your chat clean."
    )


def add_commands(dispatcher) -> None:
    # Commands
    dispatcher.add_handler(CommandHandler("start", start_timer, pass_job_queue=True))
    dispatcher.add_handler(CommandHandler("stop", stop_timer, pass_job_queue=True))
    dispatcher.add_handler(CommandHandler("help", help_command))

    dispatcher.add_handler(CommandHandler("adminsonly", admins_only))
    dispatcher.add_handler(CommandHandler("adminsonly_revert", admins_only_revert))
    dispatcher.add_handler(CommandHandler("accommodation", accommodation_command))
    dispatcher.add_handler(CommandHandler("apartments", apartments_command))
    dispatcher.add_handler(CommandHandler("animals", animal_help_command))
    dispatcher.add_handler(CommandHandler("beauty", beauty_command))
    dispatcher.add_handler(CommandHandler("cities", cities_command))
    dispatcher.add_handler(CommandHandler("cities_all", cities_all_command))
    dispatcher.add_handler(CommandHandler("countries", countries_command))
    dispatcher.add_handler(CommandHandler("countries_all", countries_all_command))
    dispatcher.add_handler(CommandHandler("entertainment", entertainment_command))
    dispatcher.add_handler(CommandHandler("evacuation", evac_command))
    dispatcher.add_handler(CommandHandler("evacuation_cities", evac_cities_command))
    dispatcher.add_handler(CommandHandler("free_stuff", free_stuff_command))
    dispatcher.add_handler(CommandHandler("food", food_command))
    dispatcher.add_handler(CommandHandler("jobs", jobs_command))
    dispatcher.add_handler(CommandHandler("meetup", meetup_command))
    dispatcher.add_handler(CommandHandler("photo", photo_command))
    dispatcher.add_handler(CommandHandler("return_to_ukraine", return_to_ukraine_command))
    dispatcher.add_handler(CommandHandler("school", school_command))
    dispatcher.add_handler(CommandHandler("search", search_command))
    dispatcher.add_handler(CommandHandler("simcards", simcards_command))
    dispatcher.add_handler(CommandHandler("vaccination", vaccination_command))
    dispatcher.add_handler(CommandHandler("volunteer", volunteer_command))

    # Articles
    dispatcher.add_handler(CommandHandler("add", add_article_command))
    dispatcher.add_handler(CommandHandler("list", list_articles_command))
    dispatcher.add_handler(CommandHandler("faq", get_article_command))
    dispatcher.add_handler(CommandHandler("delete", delete_article_command))


def get_command_list() -> List[BotCommand]:
    command_list = [
        BotCommand("accommodation", "–ü–æ–∏—Å–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∂–∏–ª—å—è"),
        BotCommand("apartments", "–ü–æ–∏—Å–∫ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –∂–∏–ª—å—è"),
        BotCommand("animals", "–ü–æ–º–æ—â—å –¥–æ–º–∞—à–Ω–∏–º –∂–∏–≤–æ—Ç–Ω—ã–º"),
        BotCommand("beauty", "Beauty —Å–æ–æ–±—â–µ—Å—Ç–≤–∞"),
        BotCommand(
            "cities",
            "–ß–∞—Ç—ã –ø–æ–º–æ—â–∏ –ø–æ –≥–æ—Ä–æ–¥–∞–º –ì–µ—Ä–º–∞–Ω–∏–∏ (–≤–≤–µ–¥–∏—Ç–µ /cities –ì–û–†–û–î)",
        ),
        BotCommand(
            "cities_all",
            "–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —á–∞—Ç–æ–≤ –ø–æ –≥–æ—Ä–æ–¥–∞–º –ì–µ—Ä–º–∞–Ω–∏–∏",
        ),
        BotCommand("countries", "–ß–∞—Ç—ã –ø–æ —Å—Ç—Ä–∞–Ω–∞–º (–≤–≤–µ–¥–∏—Ç–µ /countries –°–¢–†–ê–ù–ê)"),
        BotCommand("countries_all", "–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —á–∞—Ç–æ–≤ –ø–æ —Å—Ç—Ä–∞–Ω–∞–º"),
        BotCommand("entertainment", "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è"),
        BotCommand("evacuation", "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —ç–≤–∞–∫—É–∞—Ü–∏–∏"),
        BotCommand("evacuation_cities", "–ß–∞—Ç—ã —ç–≤–∞–∫—É–∞—Ü–∏–∏ –ø–æ –≥–æ—Ä–æ–¥–∞–º"),
        BotCommand("food", "–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –µ–¥–∞ –≤ –ë–µ—Ä–ª–∏–Ω–µ"),
        BotCommand("free_stuff", "–ì—É–º–∞–Ω–∏—Ç–∞—Ä–Ω–∞—è –ø–æ–º–æ—â—å –≤ –ë–µ—Ä–ª–∏–Ω–µ"),
        BotCommand("help", "–ß—Ç–æ —É–º–µ–µ—Ç —ç—Ç–æ—Ç –±–æ—Ç?"),
        BotCommand("jobs", "–†–∞–±–æ—Ç–∞ –≤ –ì–µ—Ä–º–∞–Ω–∏–∏"),
        BotCommand("meetup", "–ß–∞—Ç—ã –ø–æ —Ä–∞–π–Ω–æ–Ω–∞–º –ë–µ—Ä–ª–∏–Ω–∞"),
        BotCommand("photo", "–ì–¥–µ —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ"),
        BotCommand("return_to_ukraine", "–ê–ª–≥–æ—Ä–∏—Ç–º –¥–µ–π—Å—Ç–≤–∏–π –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –≤ –£–∫—Ä–∞–∏–Ω—É"),
        BotCommand("simcards", "–ì–¥–µ –ø–æ–ª—É—á–∏—Ç—å –°–ò–ú –∫–∞—Ä—Ç—É"),
        BotCommand("school", "–®–∫–æ–ª—ã"),
        BotCommand("search", "–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø–æ–∏—Å–∫–æ–º"),
        BotCommand("vaccination", "–í–∞–∫—Ü–∏–Ω–∞—Ü–∏—è"),
        BotCommand("volunteer", "–í–æ–ª–æ–Ω—Ç—ë—Ä—Å—Ç–≤–æ"),
    ]
    command_list.sort(key=lambda x: x.command)
    return command_list


@restricted
def add_article_command(bot: Bot, update: Update):
    article = parse_article(update.message, "/add", bot.name)
    if article:
        articles_service.add(article)
        reply_to_message(bot, update, "article added")
    else:
        reply_to_message(bot, update, "Invalid message format")


@restricted
def list_articles_command(bot: Bot, update: Update):
    articles = articles_service.list()
    keys_title = "".join([str(a) for a in articles])
    msg = f"**Available articles:**\n{keys_title}"
    reply_to_message(bot, update, msg)


@restricted
def get_article_command(bot: Bot, update: Update):
    key = get_param(bot, update, "/faq")
    article = articles_service.get(key)
    keys = "".join(article.keys)
    message = f"**keys:** {keys}\n{article.title}\n{article.content}"
    reply_to_message(bot, update, message)


@restricted
def delete_article_command(bot: Bot, update: Update):
    key = get_param(bot, update, "/delete")
    articles_service.delete(key)
    message = f"key {key} deleted"
    reply_to_message(bot, update, message)


def cities_all_command(bot: Bot, update: Update):
    send_results(bot, update, group_name=NameType.cities, name=None)


def countries_command(bot: Bot, update: Update):
    name = get_param(bot, update, "/countries")
    delete_command(bot, update)
    results = guidebook.get_countries(name=name)
    reply_to_message(bot, update, results)


def countries_all_command(bot: Bot, update: Update):
    send_results(bot, update, group_name=NameType.countries, name=None)


def entertainment_command(bot: Bot, update: Update):
    send_results(bot, update, group_name=NameType.entertainment, name=None)


def evac_command(bot: Bot, update: Update):
    send_results(bot, update, group_name=NameType.evacuation, name=None)


def evac_cities_command(bot: Bot, update: Update):
    name = get_param(bot, update, "/evacuation_cities")
    send_results(bot, update, group_name=NameType.evacuation_cities, name=name)


def free_stuff_command(bot: Bot, update: Update):
    name = get_param(bot, update, "/free_stuff")
    send_results(bot, update, group_name=NameType.free_stuff, name=name)


def food_command(bot: Bot, update: Update):
    send_results(bot, update, group_name=NameType.food, name=None)


def help_command(bot: Bot, update: Update):
    delete_command(bot, update)
    results = format_knowledge_results(help_text())
    reply_to_message(bot, update, results)


def jobs_command(bot: Bot, update: Update):
    send_results(bot, update, group_name=NameType.jobs, name=None)


def meetup_command(bot: Bot, update: Update):
    name = get_param(bot, update, "/meetup")
    delete_command(bot, update)
    results = guidebook.get_meetup(name=name)
    reply_to_message(bot, update, results)


def photo_command(bot: Bot, update: Update):
    send_results(bot, update, group_name=NameType.photo, name=None)


def return_to_ukraine_command(bot: Bot, update: Update):
    send_results(bot, update, group_name=NameType.return_to_ukraine, name=None)


def school_command(bot: Bot, update: Update):
    send_results(bot, update, group_name=NameType.school, name=None)


def simcards_command(bot: Bot, update: Update):
    send_results(bot, update, group_name=NameType.simcards, name=None)


def volunteer_command(bot: Bot, update: Update):
    send_results(bot, update, group_name=NameType.volunteer, name=None)


def vaccination_command(bot: Bot, update: Update):
    send_results(bot, update, group_name=NameType.vaccination, name=None)


def accommodation_command(bot: Bot, update: Update):
    send_results(bot, update, group_name=NameType.accommodation, name=None)


def animal_help_command(bot: Bot, update: Update):
    send_results(bot, update, group_name=NameType.animal_help, name=None)


def apartments_command(bot: Bot, update: Update):
    send_results(bot, update, group_name=NameType.apartments, name=None)


def beauty_command(bot: Bot, update: Update):
    send_results(bot, update, group_name=NameType.beauty, name=None)


def cities_command(bot: Bot, update: Update):
    name = get_param(bot, update, "/cities")
    delete_command(bot, update)
    results = guidebook.get_cities(name=name)
    reply_to_message(bot, update, results)


def search_command(bot: Bot, update: Update):
    send_results(bot, update, group_name=NameType.search, name=None)


@restricted
def start_timer(bot: Bot, update: Update, job_queue: JobQueue):
    """start_timer"""
    message = update.message
    chat_id = message.chat_id
    command_message_id = message.message_id
    if chat_id in BERLIN_HELPS_UKRAINE_CHAT_ID:
        reminder(bot, update, job_queue)
    try:
        bot.delete_message(chat_id=chat_id, message_id=command_message_id)
    except BadRequest:
        logger.info("Command was already deleted %s", command_message_id)


@restricted
def admins_only(bot: Bot, update: Update):
    chat_id = update.message.chat_id
    ADMIN_ONLY_CHAT_IDS.append(chat_id)
    bot.delete_message(chat_id=chat_id, message_id=update.message.message_id)


@restricted
def admins_only_revert(bot: Bot, update: Update):
    chat_id = update.message.chat_id
    ADMIN_ONLY_CHAT_IDS.remove(chat_id)
    bot.delete_message(chat_id=chat_id, message_id=update.message.message_id)


def reminder(bot: Bot, update: Update, job_queue: JobQueue):
    chat_id = update.message.chat_id
    logger.info("Started reminders in channel %s", chat_id)

    jobs: Tuple[Job] = job_queue.get_jobs_by_name(
        PINNED_JOB
    ) + job_queue.get_jobs_by_name(SOCIAL_JOB)

    #  Restart already existing jobs
    for job in jobs:
        if not job.enabled:
            job.enabled = True

    # Start a new job if there was none previously
    if not jobs:
        add_pinned_reminder_job(bot, update, job_queue)
        add_info_job(bot, update, job_queue)


def add_pinned_reminder_job(bot: Bot, update: Update, job_queue: JobQueue):
    chat_id = update.message.chat_id
    bot.send_message(
        chat_id=chat_id,
        text=f"I'm starting sending the pinned reminder every {REMINDER_INTERVAL_PINNED}s.",
    )
    job_queue.run_repeating(
        send_pinned_reminder,
        REMINDER_INTERVAL_PINNED,
        first=1,
        context=chat_id,
        name=PINNED_JOB,
    )


def add_info_job(bot: Bot, update: Update, job_queue: JobQueue):
    chat_id = update.message.chat_id
    bot.send_message(
        chat_id=chat_id,
        text=f"I'm starting sending the info reminder every {REMINDER_INTERVAL_INFO}s.",
    )
    job_queue.run_repeating(
        send_social_reminder,
        REMINDER_INTERVAL_INFO,
        first=1,
        context=chat_id,
        name=SOCIAL_JOB,
    )


@restricted
def stop_timer(bot: Bot, update: Update, job_queue: JobQueue):
    """stop_timer"""
    chat_id = update.message.chat_id

    #  Stop already existing jobs
    jobs: Tuple[Job] = job_queue.get_jobs_by_name(chat_id)
    for job in jobs:
        bot.send_message(chat_id=chat_id, text="I'm stopping sending the reminders.")
        job.enabled = False

    logger.info("Stopped reminders in channel %s", chat_id)


def send_pinned_reminder(bot: Bot, job: Job):
    """send_reminder"""
    chat_id = job.context
    chat = bot.get_chat(chat_id)
    msg: Message = chat.pinned_message
    logger.info("Sending pinned message to chat %s", chat_id)

    if msg:
        bot.forward_message(chat_id, chat_id, msg.message_id)
    else:
        bot.send_message(chat_id=chat_id, text=REMINDER_MESSAGE)


def send_social_reminder(bot: Bot, job: Job):
    """send_reminder"""
    chat_id = job.context
    logger.info("Sending a social reminder to chat %s", chat_id)
    results = guidebook.get_results(group_name=NameType.social_help, name=None)
    bot.send_message(chat_id=chat_id, text=results, disable_web_page_preview=True)


def find_articles_command(update: Update) -> None:
    """Handle the inline query."""
    query = update.inline_query.query

    articles = articles_service.find(query)
    results = [
        InlineQueryResultArticle(
            id=a.id,
            title=a.title,
            input_message_content=InputTextMessageContent(
                str(a), parse_mode=ParseMode.MARKDOWN
            ),
            thumb_url=THUMB_URL,
        )
        for a in articles
    ]

    update.inline_query.answer(results)


def delete_greetings(bot: Bot, update: Update) -> None:
    """Echo the user message."""
    message = update.message
    if message:
        msg_type = effective_message_type(message)
        logger.debug("Handling type is %s", msg_type)
        if effective_message_type(message) in [
            "new_chat_members",
            "left_chat_member",
        ]:
            bot.delete_message(chat_id=message.chat_id, message_id=message.message_id)
